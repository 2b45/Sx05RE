From 8fd55883971991cea205abcde742b2f9eb199320 Mon Sep 17 00:00:00 2001
From: Sam Nazarko <email@samnazarko.co.uk>
Date: Wed, 14 Mar 2018 18:03:38 +0000
Subject: [PATCH 1/3] hdmi_tx: add support for controlling dithering and
 rounding via debug interface

Signed-off-by: Sam Nazarko <email@samnazarko.co.uk>
---
 drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c b/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c
index 06a021051bb0..fa4c15b3493a 100644
--- a/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c
+++ b/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c
@@ -3198,6 +3198,20 @@ static void hdmitx_debug(struct hdmitx_dev *hdev, const char *buf)
 			hdmi_print(INF, HPD "hdmitx: unlock hpd\n");
 		}
 		return;
+	} else if (strncmp(tmpbuf, "dither", 5) == 0) {
+		int dither = 0;
+		if (tmpbuf[6] == '1')
+			dither = 1;
+		hd_set_reg_bits(P_VPU_HDMI_FMT_CTRL, dither, 4, 1);
+		hdmi_print(INF, SYS, "hdmitx: adjust dither to %d", dither);
+		return;
+	} else if (strncmp(tmpbuf, "round", 5) == 0) {
+		int round = 0;
+		if (tmpbuf[6] == '1')
+			round = 1;
+		hd_set_reg_bits(P_VPU_HDMI_FMT_CTRL, round, 10, 1);
+		hdmi_print(INF, SYS, "hdmitx: adjust round to %d", round);
+		return;
 	} else if (strncmp(tmpbuf, "hpd_stick", 9) == 0) {
 		if (tmpbuf[9] == '1')
 			hdev->hdcp_hpd_stick = 1;

From dd80f4192ff63b837d94050dc58ea81cf0d74df7 Mon Sep 17 00:00:00 2001
From: Sam Nazarko <email@samnazarko.co.uk>
Date: Wed, 14 Mar 2018 18:28:32 +0000
Subject: [PATCH 2/3] hdhmi_tx: SoC vendor send AVI.BT2020 when HDR is engaged.
 This should be decoupled according to the ITU.BT2020 spec. To allow us to
 follow upstream, add support for setting BT2020 or BT709 infoframe via sysfs.
 Needs poking from Kodi.

Signed-off-by: Sam Nazarko <email@samnazarko.co.uk>
---
 drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c b/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c
index fa4c15b3493a..e6addee3a61a 100644
--- a/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c
+++ b/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c
@@ -3212,6 +3212,16 @@ static void hdmitx_debug(struct hdmitx_dev *hdev, const char *buf)
 		hd_set_reg_bits(P_VPU_HDMI_FMT_CTRL, round, 10, 1);
 		hdmi_print(INF, SYS, "hdmitx: adjust round to %d", round);
 		return;
+	} else if (strncmp(tmpbuf, "do2020", 6) == 0) {
+		hdmi_print(INF, SYS, "hdmitx: BT2020 AVI on");
+		hdmitx_set_reg_bits(HDMITX_DWC_FC_AVICONF1, 3, 6, 2);
+		hdmitx_set_reg_bits(HDMITX_DWC_FC_AVICONF2, 6, 4, 3);
+		return;
+	} else if (strncmp(tmpbuf, "no2020", 6) == 0) {
+		hdmi_print(INF, SYS, "hdmitx: BT2020 AVI off");
+		hdmitx_set_reg_bits(HDMITX_DWC_FC_AVICONF1, 2, 6, 2);
+		hdmitx_set_reg_bits(HDMITX_DWC_FC_AVICONF2, 0, 4, 3);
+		return;
 	} else if (strncmp(tmpbuf, "hpd_stick", 9) == 0) {
 		if (tmpbuf[9] == '1')
 			hdev->hdcp_hpd_stick = 1;

From fb88065ab2e1f27d9c42bc71c5caa9c87eb8ecb2 Mon Sep 17 00:00:00 2001
From: Sam Nazarko <email@samnazarko.co.uk>
Date: Thu, 15 Mar 2018 23:25:10 +0000
Subject: [PATCH 3/3] hdmi_tx_hw: fix banding issue

Signed-off-by: Sam Nazarko <email@samnazarko.co.uk>
---
 drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c b/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c
index e6addee3a61a..a8ba73277a39 100644
--- a/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c
+++ b/drivers/amlogic/hdmi/hdmi_tx_20/hw/hdmi_tx_hw.c
@@ -2211,7 +2211,7 @@ static int hdmitx_set_dispmode(struct hdmitx_dev *hdev)
 			hd_set_reg_bits(P_VPU_HDMI_DITH_CNTL, hs_flag, 2, 2);
 		} else {
 			hd_set_reg_bits(P_VPU_HDMI_FMT_CTRL, 0, 4, 1);
-			hd_set_reg_bits(P_VPU_HDMI_FMT_CTRL, 0, 10, 1);
+			hd_set_reg_bits(P_VPU_HDMI_FMT_CTRL, 1, 10, 1);
 		}
 		break;
 	default:
